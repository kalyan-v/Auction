{% extends "base.html" %}

{% block title %}Fantasy Points - Player Auction System{% endblock %}

{% block content %}
<h2>Fantasy Points</h2>

{% if not admin_mode %}
<div class="readonly-banner">
    üîí <strong>View Only Mode</strong> - <a href="{{ url_for('main.login') }}">Login as admin</a> to manage fantasy points
</div>
{% endif %}

<!-- Special Awards Section -->
<div class="awards-section">
    <h3>üèÜ Special Awards</h3>
    {% if admin_mode %}
    <div class="awards-actions">
        <button class="btn btn-small btn-primary" onclick="fetchAllData()" id="fetchAllBtn">üì° Fetch WPL Data</button>
    </div>
    {% endif %}
    <div class="awards-container">
        <div class="award-card mvp">
            <div class="award-image-container">
                {% if mvp and mvp.player and mvp.player.image_url %}
                <img src="{{ mvp.player.image_url }}" alt="{{ mvp.player.name }}" class="award-player-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="award-icon fallback" style="display:none;">üèÖ</div>
                {% else %}
                <div class="award-icon">üèÖ</div>
                {% endif %}
            </div>
            <div class="award-info">
                <h4>MVP</h4>
                <p class="award-description">Most Valuable Player</p>
                {% if admin_mode %}
                <select id="mvp-select" class="award-select" onchange="setAward('mvp', this.value)">
                    <option value="">-- Select Player --</option>
                    {% for player in all_players %}
                    <option value="{{ player.id }}" {% if mvp and mvp.player_id == player.id %}selected{% endif %}>
                        {{ player.name }} ({{ player.team.name if player.team else 'No Team' }})
                    </option>
                    {% endfor %}
                </select>
                {% else %}
                <p class="award-winner">{{ mvp.player.name if mvp and mvp.player else 'N/A' }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="award-card orange-cap">
            <div class="award-image-container">
                {% if orange_cap and orange_cap.player and orange_cap.player.image_url %}
                <img src="{{ orange_cap.player.image_url }}" alt="{{ orange_cap.player.name }}" class="award-player-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="award-icon fallback" style="display:none;">üß¢</div>
                {% else %}
                <div class="award-icon">üß¢</div>
                {% endif %}
            </div>
            <div class="award-info">
                <h4>Orange Cap</h4>
                <p class="award-description">Most Runs</p>
                {% if admin_mode %}
                <select id="orange-cap-select" class="award-select" onchange="setAward('orange_cap', this.value)">
                    <option value="">-- Select Player --</option>
                    {% for player in all_players %}
                    <option value="{{ player.id }}" {% if orange_cap and orange_cap.player_id == player.id %}selected{% endif %}>
                        {{ player.name }} ({{ player.team.name if player.team else 'No Team' }})
                    </option>
                    {% endfor %}
                </select>
                {% else %}
                <p class="award-winner">{{ orange_cap.player.name if orange_cap and orange_cap.player else 'N/A' }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="award-card purple-cap">
            <div class="award-image-container">
                {% if purple_cap and purple_cap.player and purple_cap.player.image_url %}
                <img src="{{ purple_cap.player.image_url }}" alt="{{ purple_cap.player.name }}" class="award-player-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="award-icon fallback" style="display:none;">üß¢</div>
                {% else %}
                <div class="award-icon">üß¢</div>
                {% endif %}
            </div>
            <div class="award-info">
                <h4>Purple Cap</h4>
                <p class="award-description">Most Wickets</p>
                {% if admin_mode %}
                <select id="purple-cap-select" class="award-select" onchange="setAward('purple_cap', this.value)">
                    <option value="">-- Select Player --</option>
                    {% for player in all_players %}
                    <option value="{{ player.id }}" {% if purple_cap and purple_cap.player_id == player.id %}selected{% endif %}>
                        {{ player.name }} ({{ player.team.name if player.team else 'No Team' }})
                    </option>
                    {% endfor %}
                </select>
                {% else %}
                <p class="award-winner">{{ purple_cap.player.name if purple_cap and purple_cap.player else 'N/A' }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <div class="filter-group">
        <label>Filter by:</label>
        <select id="filterType" onchange="updateFilterOptions()">
            <option value="none">All Players</option>
            <option value="team">Original Team</option>
            <option value="position">Position</option>
        </select>
        <select id="filterValue" onchange="applyFilter()" style="display: none;">
            <option value="">Select...</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFilter()">Clear Filter</button>
    </div>
</div>

<!-- Team Fantasy Points Section -->
<div class="fantasy-container">
    {% for team in teams %}
    {% set team_players = team.players | selectattr('status', 'equalto', 'sold') | list %}
    {% if team_players %}
    {% set team_class = team.name | lower | replace(' ', '-') %}
    <div class="team-card fantasy-card team-{{ team_class }}" data-team-id="{{ team.id }}">
        <div class="team-header">
            <h3>{{ team.name }}</h3>
            <div class="team-stats">
                <div class="stat">
                    <span class="stat-label">Players</span>
                    <span class="stat-value">{{ team_players | length }}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Points</span>
                    <span class="stat-value fantasy-total" id="team-total-{{ team.id }}">
                        {{ team_players | sum(attribute='fantasy_points') | round(1) }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="players-list">
            <div class="table-responsive">
            <table class="squad-table fantasy-table" id="table-{{ team.id }}">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th class="sortable" onclick="sortTable({{ team.id }}, 'points')">
                            Total Points <span class="sort-icon" id="sort-points-{{ team.id }}">‚áÖ</span>
                        </th>
                        <th>Original Team</th>
                        <th class="sortable" onclick="sortTable({{ team.id }}, 'position')">
                            Position <span class="sort-icon" id="sort-position-{{ team.id }}">‚áÖ</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in team_players %}
                    <tr class="player-row clickable-row" 
                        data-player-id="{{ player.id }}" 
                        data-player-name="{{ player.name }}"
                        data-team-id="{{ team.id }}"
                        data-position="{{ player.position }}"
                        data-original-team="{{ player.original_team or '' }}"
                        data-points="{{ player.fantasy_points }}"
                        onclick="showPointsModalFromRow(this)">
                        <td class="player-name-cell">
                            {% if player.image_url %}
                            <img src="{{ player.image_url }}" alt="" class="player-thumbnail" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <span class="player-thumbnail-placeholder" style="display:none;">üèè</span>
                            {% else %}
                            <span class="player-thumbnail-placeholder">üèè</span>
                            {% endif %}
                            <span class="player-name-text">{{ player.name }}</span>
                        </td>
                        <td class="points-cell">
                            <span class="points-value" id="points-{{ player.id }}">{{ player.fantasy_points }}</span>
                        </td>
                        <td><span class="original-team-badge">{{ player.original_team or '-' }}</span></td>
                        <td><span class="position-badge {{ player.position | lower }}">{{ player.position }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

{% set has_sold_players = teams | map(attribute='players') | sum(start=[]) | selectattr('status', 'equalto', 'sold') | list | length > 0 %}
{% if not teams or not has_sold_players %}
<div class="empty-state-large">
    <div class="empty-state-icon">‚≠ê</div>
    <p class="empty-state-text">No Fantasy Points Yet</p>
    <p class="empty-state-hint">Complete the auction first to start tracking fantasy points</p>
    <a href="{{ url_for('auction.auction_room') }}" class="btn btn-primary" style="margin-top: 1rem;">üî® Go to Auction</a>
</div>
{% endif %}

<!-- Fantasy Points Modal -->
<div id="fantasyModal" class="modal">
    <div class="modal-content fantasy-modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modalPlayerName">Player Name - Fantasy Points</h3>
        
        <div class="modal-total-points">
            <span>Total Points:</span>
            <span id="modalTotalPoints" class="total-value">0</span>
        </div>
        
        <div id="matchPointsContainer">
            <!-- Match points will be loaded here -->
        </div>
        
        {% if admin_mode %}
        <div class="add-points-section">
            <h4>‚ûï Add Match Points</h4>
            <div class="add-points-form">
                <div class="form-group">
                    <label for="matchNumber">WPL Match #</label>
                    <input type="number" id="matchNumber" min="1" placeholder="WPL Match #">
                </div>
                <div class="form-group">
                    <label for="matchPoints">Points</label>
                    <input type="number" id="matchPoints" step="0.5" placeholder="Points">
                </div>
                <button class="btn btn-primary" onclick="addMatchPoints()">Add Points</button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentPlayerId = null;
let currentTeamId = null;
const isAdmin = {{ 'true' if admin_mode else 'false' }};

// Fetch all WPL data (awards + fantasy points)
async function fetchAllData() {
    const btn = document.getElementById('fetchAllBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;

    try {
        // Step 1: Fetch fantasy points from match scorecards
        btn.innerHTML = '‚è≥ Fetching match data...';
        const pointsResponse = await fetch('/api/fantasy/fetch-match-points', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const pointsData = await pointsResponse.json();

        let statusMsg = '';
        if (pointsData.success) {
            statusMsg += `Matches: ${pointsData.matches_scraped}, Players: ${pointsData.players_updated}`;
        }

        // Step 2: Fetch awards
        btn.innerHTML = '‚è≥ Fetching awards...';
        const awardsResponse = await fetch('/api/fantasy/fetch-awards', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const awardsData = await awardsResponse.json();

        // Step 3: Fetch images for award winners
        if (awardsData.results) {
            btn.innerHTML = '‚è≥ Fetching images...';
            const playerIds = [];
            if (awardsData.results.orange_cap) playerIds.push(awardsData.results.orange_cap.player_id);
            if (awardsData.results.purple_cap) playerIds.push(awardsData.results.purple_cap.player_id);
            if (awardsData.results.mvp) playerIds.push(awardsData.results.mvp.player_id);

            for (const playerId of playerIds) {
                if (playerId) {
                    try {
                        await fetch(`/api/players/${playerId}/fetch-image`, { method: 'POST' });
                    } catch (e) {
                        console.error('Error fetching image:', e);
                    }
                }
            }
        }

        // Show summary and reload
        let finalMsg = 'WPL data updated!\n';
        if (statusMsg) finalMsg += statusMsg + '\n';
        if (awardsData.results) finalMsg += 'Awards fetched';

        showNotification(finalMsg, 'success');
        setTimeout(() => location.reload(), 1500);

    } catch (error) {
        showNotification('Error fetching data: ' + error.message, 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Helper to show modal using data attributes (safe for special characters in names)
function showPointsModalFromRow(row) {
    const playerId = parseInt(row.dataset.playerId, 10);
    const playerName = row.dataset.playerName;
    const teamId = parseInt(row.dataset.teamId, 10);
    showPointsModal(playerId, playerName, teamId);
}

// Track sort state for each team
const sortState = {};

function sortTable(teamId, sortBy) {
    const table = document.getElementById(`table-${teamId}`);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    if (rows.length === 0) return;
    
    // Initialize or toggle sort state
    if (!sortState[teamId]) {
        sortState[teamId] = { column: null, ascending: true };
    }
    
    // Toggle direction if same column, otherwise reset to descending for points, ascending for position
    if (sortState[teamId].column === sortBy) {
        sortState[teamId].ascending = !sortState[teamId].ascending;
    } else {
        sortState[teamId].column = sortBy;
        sortState[teamId].ascending = sortBy === 'position'; // ascending for position, descending for points
    }
    
    const ascending = sortState[teamId].ascending;
    
    // Position order for sorting
    const positionOrder = { 'Batter': 1, 'Keeper': 2, 'Allrounder': 3, 'Bowler': 4 };
    
    rows.sort((a, b) => {
        let valA, valB;
        
        if (sortBy === 'position') {
            valA = positionOrder[a.dataset.position] || 99;
            valB = positionOrder[b.dataset.position] || 99;
        } else if (sortBy === 'points') {
            valA = parseFloat(a.dataset.points) || 0;
            valB = parseFloat(b.dataset.points) || 0;
        }
        
        if (ascending) {
            return valA - valB;
        } else {
            return valB - valA;
        }
    });
    
    // Re-append rows in sorted order
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort icons
    updateSortIcons(teamId, sortBy, ascending);
}

function updateSortIcons(teamId, activeColumn, ascending) {
    // Reset all icons for this team
    const positionIcon = document.getElementById(`sort-position-${teamId}`);
    const pointsIcon = document.getElementById(`sort-points-${teamId}`);
    
    if (positionIcon) positionIcon.textContent = '‚áÖ';
    if (pointsIcon) pointsIcon.textContent = '‚áÖ';
    
    // Set active icon
    const activeIcon = document.getElementById(`sort-${activeColumn}-${teamId}`);
    if (activeIcon) {
        activeIcon.textContent = ascending ? '‚Üë' : '‚Üì';
    }
}

async function showPointsModal(playerId, playerName, teamId) {
    currentPlayerId = playerId;
    currentTeamId = teamId;
    
    const modal = document.getElementById('fantasyModal');
    const playerNameEl = document.getElementById('modalPlayerName');
    const containerEl = document.getElementById('matchPointsContainer');
    
    playerNameEl.textContent = playerName + ' - Fantasy Points';
    containerEl.innerHTML = '<p>Loading...</p>';
    modal.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/fantasy/points/${playerId}`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('modalTotalPoints').textContent = data.player.total_points;
            
            if (data.entries.length > 0) {
                let html = `
                    <table class="match-points-table">
                        <thead>
                            <tr>
                                <th>Match #</th>
                                <th>Points</th>
                                ${isAdmin ? '<th>Action</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.entries.forEach((entry, index) => {
                    html += `
                        <tr>
                            <td>Match ${index + 1} <span class="match-actual">(#${entry.match_number})</span></td>
                            <td class="points-cell">${entry.points}</td>
                            ${isAdmin ? `<td><button class="btn btn-small btn-danger" onclick="deleteMatchPoints(${entry.id})">üóëÔ∏è</button></td>` : ''}
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                containerEl.innerHTML = html;
            } else {
                containerEl.innerHTML = '<p class="no-matches">No match points recorded yet.</p>';
            }
            
            // Reset add form - suggest next WPL match number
            if (isAdmin) {
                const nextMatch = data.entries.length > 0
                    ? Math.max(...data.entries.map(e => e.match_number)) + 1
                    : 1;
                document.getElementById('matchNumber').value = nextMatch;
                document.getElementById('matchPoints').value = '';
            }
        } else {
            containerEl.innerHTML = '<p class="error">Error loading points: ' + escapeHtml(data.error) + '</p>';
        }
    } catch (error) {
        containerEl.innerHTML = '<p class="error">Error loading points: ' + escapeHtml(error.message) + '</p>';
    }
}

function closeModal() {
    document.getElementById('fantasyModal').style.display = 'none';
    currentPlayerId = null;
    currentTeamId = null;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('fantasyModal');
    if (event.target === modal) {
        closeModal();
    }
}

// Close modal on ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

let isAddingPoints = false;
async function addMatchPoints() {
    if (!currentPlayerId || isAddingPoints) return;

    const matchNumberEl = document.getElementById('matchNumber');
    const matchPointsEl = document.getElementById('matchPoints');
    const matchNumber = parseInt(matchNumberEl?.value, 10);
    const points = parseFloat(matchPointsEl?.value);

    if (!matchNumber || matchNumber < 1 || isNaN(matchNumber)) {
        showNotification('Please enter a valid match number', 'error');
        return;
    }

    if (isNaN(points)) {
        showNotification('Please enter a points value', 'error');
        return;
    }

    isAddingPoints = true;
    const addBtn = document.querySelector('.add-points-form .btn-primary');
    if (addBtn) {
        addBtn.disabled = true;
        addBtn.textContent = '‚è≥ Adding...';
    }

    try {
        const response = await fetch('/api/fantasy/points/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                player_id: currentPlayerId,
                match_number: matchNumber,
                points: points
            })
        });

        const data = await response.json();

        if (data.success) {
            // Refresh the modal
            const playerNameEl = document.getElementById('modalPlayerName');
            const playerName = playerNameEl ? playerNameEl.textContent.replace(' - Fantasy Points', '') : '';
            showPointsModal(currentPlayerId, playerName, currentTeamId);

            // Update the main table
            const pointsEl = document.getElementById(`points-${currentPlayerId}`);
            if (pointsEl) pointsEl.textContent = data.total_points;
            updateTeamTotal(currentTeamId);
            showNotification('Points added successfully!', 'success');
        } else {
            showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showNotification('Error adding points: ' + error.message, 'error');
    } finally {
        isAddingPoints = false;
        if (addBtn) {
            addBtn.disabled = false;
            addBtn.textContent = 'Add Points';
        }
    }
}

async function deleteMatchPoints(entryId) {
    if (!confirm('Are you sure you want to delete this match entry?')) {
        return;
    }

    // Find and disable the delete button
    const deleteBtn = document.querySelector(`button[onclick="deleteMatchPoints(${entryId})"]`);
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.textContent = '‚è≥';
    }

    try {
        const response = await fetch(`/api/fantasy/points/delete/${entryId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
            // Refresh the modal
            const playerNameEl = document.getElementById('modalPlayerName');
            const playerName = playerNameEl ? playerNameEl.textContent.replace(' - Fantasy Points', '') : '';
            showPointsModal(currentPlayerId, playerName, currentTeamId);
            
            // Update the main table
            const pointsEl = document.getElementById(`points-${currentPlayerId}`);
            if (pointsEl) pointsEl.textContent = data.total_points;
            updateTeamTotal(currentTeamId);
            showNotification('Match entry deleted', 'success');
        } else {
            showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showNotification('Error deleting entry: ' + error.message, 'error');
    }
}

function updateTeamTotal(teamId) {
    if (!teamId) return;
    const rows = document.querySelectorAll(`tr[data-team-id="${teamId}"]`);
    let total = 0;

    rows.forEach(row => {
        const playerId = row.dataset.playerId;
        if (playerId) {
            const pointsEl = document.getElementById(`points-${playerId}`);
            total += parseFloat(pointsEl?.textContent) || 0;
        }
    });

    const totalEl = document.getElementById(`team-total-${teamId}`);
    if (totalEl) {
        totalEl.textContent = total.toFixed(1);
    }
}

async function setAward(awardType, playerId) {
    const select = document.getElementById(`${awardType.replace('_', '-')}-select`);
    if (select) select.disabled = true;

    try {
        const response = await fetch('/api/fantasy/award', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ award_type: awardType, player_id: playerId || null })
        });

        const data = await response.json();

        if (data.success) {
            // Show brief success feedback
            if (select) {
                select.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    select.style.backgroundColor = '';
                }, 500);
            }
            showNotification('Award updated!', 'success');
        } else {
            showNotification('Error: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showNotification('Error setting award: ' + error.message, 'error');
    } finally {
        if (select) select.disabled = false;
    }
}

// Filter functionality - dynamically get values from page data
function getUniqueValues(attribute) {
    const values = new Set();
    document.querySelectorAll('.player-row').forEach(row => {
        const val = row.dataset[attribute];
        if (val && val.trim()) values.add(val.trim());
    });
    return Array.from(values).sort();
}

const positions = ['Batter', 'Keeper', 'Allrounder', 'Bowler'];

function updateFilterOptions() {
    const filterType = document.getElementById('filterType').value;
    const filterValueSelect = document.getElementById('filterValue');
    
    if (filterType === 'none') {
        filterValueSelect.style.display = 'none';
        clearFilter();
        return;
    }
    
    filterValueSelect.style.display = 'inline-block';
    filterValueSelect.innerHTML = '<option value="">Select...</option>';
    
    // Get dynamic values from page data
    const options = filterType === 'team' ? getUniqueValues('originalTeam') : positions;
    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        filterValueSelect.appendChild(option);
    });
}

function applyFilter() {
    const filterType = document.getElementById('filterType').value;
    const filterValue = document.getElementById('filterValue').value;
    
    if (!filterValue) {
        clearFilter();
        return;
    }
    
    const allRows = document.querySelectorAll('.player-row');
    
    allRows.forEach(row => {
        let match = false;
        
        if (filterType === 'team') {
            match = row.dataset.originalTeam === filterValue;
        } else if (filterType === 'position') {
            match = row.dataset.position === filterValue;
        }
        
        row.style.display = match ? '' : 'none';
    });
    
    // Hide team cards with no visible players
    updateTeamCardVisibility();
}

function clearFilter() {
    document.getElementById('filterType').value = 'none';
    document.getElementById('filterValue').value = '';
    document.getElementById('filterValue').style.display = 'none';
    
    const allRows = document.querySelectorAll('.player-row');
    allRows.forEach(row => {
        row.style.display = '';
    });
    
    // Show all team cards
    document.querySelectorAll('.fantasy-card').forEach(card => {
        card.style.display = '';
    });
}

function updateTeamCardVisibility() {
    document.querySelectorAll('.fantasy-card').forEach(card => {
        const visibleRows = card.querySelectorAll('.player-row[style=""], .player-row:not([style])');
        const hiddenRows = card.querySelectorAll('.player-row[style*="display: none"]');
        
        // Check if all rows in this card are hidden
        const allRows = card.querySelectorAll('.player-row');
        const allHidden = Array.from(allRows).every(row => row.style.display === 'none');
        
        card.style.display = allHidden ? 'none' : '';
    });
}

// Sort all tables by position on page load
document.addEventListener('DOMContentLoaded', function() {
    const teamCards = document.querySelectorAll('.fantasy-card[data-team-id]');
    teamCards.forEach(card => {
        const teamId = card.dataset.teamId;
        if (teamId) {
            sortTable(parseInt(teamId, 10), 'points');
        }
    });
});
</script>
{% endblock %}
