{% extends "base.html" %}

{% block title %}Squads - Player Auction System{% endblock %}

{% block content %}
<h2>Team Squads</h2>

{% if not admin_mode %}
<div class="readonly-banner">
    ðŸ”’ <strong>View Only Mode</strong> - <a href="{{ url_for('main.login') }}">Login as admin</a> to release players back to auction
</div>
{% endif %}

<div class="squads-container">
    {% for team in teams %}
    <div class="team-card">
        <div class="team-header">
            <h3>{{ team.name }}</h3>
            <div class="team-stats">
                <div class="stat">
                    <span class="stat-label">Purse Left</span>
                    <span class="stat-value purse">â‚¹{{ '{:.2f}'.format(team.budget / 10000000) }} Cr</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Players</span>
                    <span class="stat-value">{{ team.players | length }}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Spent</span>
                    <span class="stat-value spent">â‚¹{{ '{:.2f}'.format(((team.initial_budget or 500000000) - team.budget) / 10000000) }} Cr</span>
                </div>
            </div>
        </div>
        
        <div class="players-list">
            {% if team.players %}
                <table class="squad-table">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Position</th>
                            <th>Price</th>
                            {% if admin_mode %}<th>Action</th>{% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in team.players %}
                        <tr class="player-row">
                            <td onclick="showBidHistory({{ player.id }}, '{{ player.name }}')">{{ player.name }}</td>
                            <td onclick="showBidHistory({{ player.id }}, '{{ player.name }}')"><span class="position-badge {{ player.position | lower }}">{{ player.position }}</span></td>
                            <td class="price" onclick="showBidHistory({{ player.id }}, '{{ player.name }}')">â‚¹{{ '{:.0f}'.format(player.current_price / 100000) }} L</td>
                            {% if admin_mode %}
                            <td>
                                <button class="btn btn-small btn-danger release-btn" onclick="releasePlayer({{ player.id }}, '{{ player.name }}', event)">ðŸ”„ Release</button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="no-players">No players yet</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Bid History Modal -->
<div id="bidModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modalPlayerName">Player Name</h3>
        <div id="modalBidHistory"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function releasePlayer(playerId, playerName, event) {
    event.stopPropagation(); // Prevent triggering bid history modal
    
    if (!confirm(`Are you sure you want to release ${playerName} back to auction?\n\nThis will:\nâ€¢ Remove them from the team\nâ€¢ Refund the purchase price to the team\nâ€¢ Reset them to available status\nâ€¢ Delete all bid history`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/players/${playerId}/release`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error releasing player: ' + error.message);
    }
}

async function showBidHistory(playerId, playerName) {
    const modal = document.getElementById('bidModal');
    const playerNameEl = document.getElementById('modalPlayerName');
    const bidHistoryEl = document.getElementById('modalBidHistory');
    
    playerNameEl.textContent = playerName + ' - Bid History';
    bidHistoryEl.innerHTML = '<p>Loading...</p>';
    modal.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/players/${playerId}/bids`);
        const data = await response.json();
        
        if (data.success) {
            if (data.bids.length > 0) {
                let html = `
                    <div class="final-price">
                        <strong>Final Price:</strong> â‚¹${(data.player.final_price / 100000).toFixed(0)} L
                    </div>
                    <table class="bid-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Team</th>
                                <th>Amount</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.bids.forEach((bid, index) => {
                    const isWinning = index === 0;
                    html += `
                        <tr class="${isWinning ? 'winning-bid' : ''}">
                            <td>${data.bids.length - index}</td>
                            <td>${bid.team_name}</td>
                            <td>â‚¹${(bid.amount / 100000).toFixed(0)} L</td>
                            <td>${bid.timestamp}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                bidHistoryEl.innerHTML = html;
            } else {
                bidHistoryEl.innerHTML = '<p class="no-bids">No bid history available</p>';
            }
        } else {
            bidHistoryEl.innerHTML = '<p class="error">Error loading bid history</p>';
        }
    } catch (error) {
        bidHistoryEl.innerHTML = '<p class="error">Error loading bid history</p>';
    }
}

function closeModal() {
    document.getElementById('bidModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('bidModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %}
