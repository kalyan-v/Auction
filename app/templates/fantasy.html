{% extends "base.html" %}

{% block title %}Fantasy Points - Player Auction System{% endblock %}

{% block content %}
<h2>Fantasy Points</h2>

{% if not admin_mode %}
<div class="readonly-banner">
    üîí <strong>View Only Mode</strong> - <a href="{{ url_for('main.login') }}">Login as admin</a> to manage fantasy points
</div>
{% endif %}

<!-- Special Awards Section -->
<div class="awards-section">
    <h3>üèÜ Special Awards</h3>
    {% if admin_mode %}
    <div class="awards-actions">
        <button class="btn btn-small btn-secondary" onclick="fetchAllAwardImages()">üîÑ Fetch Award Images</button>
    </div>
    {% endif %}
    <div class="awards-container">
        <div class="award-card mvp">
            <div class="award-image-container">
                {% if mvp and mvp.player and mvp.player.image_url %}
                <img src="{{ mvp.player.image_url }}" alt="{{ mvp.player.name }}" class="award-player-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="award-icon fallback" style="display:none;">üèÖ</div>
                {% else %}
                <div class="award-icon">üèÖ</div>
                {% endif %}
            </div>
            <div class="award-info">
                <h4>MVP</h4>
                <p class="award-description">Most Valuable Player</p>
                {% if admin_mode %}
                <select id="mvp-select" class="award-select" onchange="setAward('mvp', this.value)">
                    <option value="">-- Select Player --</option>
                    {% for player in all_players %}
                    <option value="{{ player.id }}" {% if mvp and mvp.player_id == player.id %}selected{% endif %}>
                        {{ player.name }} ({{ player.team.name if player.team else 'No Team' }})
                    </option>
                    {% endfor %}
                </select>
                {% else %}
                <p class="award-winner">{{ mvp.player.name if mvp and mvp.player else 'N/A' }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="award-card orange-cap">
            <div class="award-image-container">
                {% if orange_cap and orange_cap.player and orange_cap.player.image_url %}
                <img src="{{ orange_cap.player.image_url }}" alt="{{ orange_cap.player.name }}" class="award-player-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="award-icon fallback" style="display:none;">üß¢</div>
                {% else %}
                <div class="award-icon">üß¢</div>
                {% endif %}
            </div>
            <div class="award-info">
                <h4>Orange Cap</h4>
                <p class="award-description">Most Runs</p>
                {% if admin_mode %}
                <select id="orange-cap-select" class="award-select" onchange="setAward('orange_cap', this.value)">
                    <option value="">-- Select Player --</option>
                    {% for player in all_players %}
                    <option value="{{ player.id }}" {% if orange_cap and orange_cap.player_id == player.id %}selected{% endif %}>
                        {{ player.name }} ({{ player.team.name if player.team else 'No Team' }})
                    </option>
                    {% endfor %}
                </select>
                {% else %}
                <p class="award-winner">{{ orange_cap.player.name if orange_cap and orange_cap.player else 'N/A' }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="award-card purple-cap">
            <div class="award-image-container">
                {% if purple_cap and purple_cap.player and purple_cap.player.image_url %}
                <img src="{{ purple_cap.player.image_url }}" alt="{{ purple_cap.player.name }}" class="award-player-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="award-icon fallback" style="display:none;">üß¢</div>
                {% else %}
                <div class="award-icon">üß¢</div>
                {% endif %}
            </div>
            <div class="award-info">
                <h4>Purple Cap</h4>
                <p class="award-description">Most Wickets</p>
                {% if admin_mode %}
                <select id="purple-cap-select" class="award-select" onchange="setAward('purple_cap', this.value)">
                    <option value="">-- Select Player --</option>
                    {% for player in all_players %}
                    <option value="{{ player.id }}" {% if purple_cap and purple_cap.player_id == player.id %}selected{% endif %}>
                        {{ player.name }} ({{ player.team.name if player.team else 'No Team' }})
                    </option>
                    {% endfor %}
                </select>
                {% else %}
                <p class="award-winner">{{ purple_cap.player.name if purple_cap and purple_cap.player else 'N/A' }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <div class="filter-group">
        <label>Filter by:</label>
        <select id="filterType" onchange="updateFilterOptions()">
            <option value="none">All Players</option>
            <option value="team">Original Team</option>
            <option value="position">Position</option>
        </select>
        <select id="filterValue" onchange="applyFilter()" style="display: none;">
            <option value="">Select...</option>
        </select>
        <button class="btn btn-secondary" onclick="clearFilter()">Clear Filter</button>
    </div>
</div>

<!-- Team Fantasy Points Section -->
<div class="fantasy-container">
    {% for team in teams %}
    {% set team_players = team.players | selectattr('status', 'equalto', 'sold') | list %}
    {% if team_players %}
    <div class="team-card fantasy-card" data-team-id="{{ team.id }}">
        <div class="team-header">
            <h3>{{ team.name }}</h3>
            <div class="team-stats">
                <div class="stat">
                    <span class="stat-label">Players</span>
                    <span class="stat-value">{{ team_players | length }}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Points</span>
                    <span class="stat-value fantasy-total" id="team-total-{{ team.id }}">
                        {{ team_players | sum(attribute='fantasy_points') | round(1) }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="players-list">
            <table class="squad-table fantasy-table" id="table-{{ team.id }}">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Original Team</th>
                        <th class="sortable" onclick="sortTable({{ team.id }}, 'position')">
                            Position <span class="sort-icon" id="sort-position-{{ team.id }}">‚áÖ</span>
                        </th>
                        <th class="sortable" onclick="sortTable({{ team.id }}, 'points')">
                            Total Points <span class="sort-icon" id="sort-points-{{ team.id }}">‚áÖ</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in team_players %}
                    <tr class="player-row clickable-row" 
                        data-player-id="{{ player.id }}" 
                        data-player-name="{{ player.name }}"
                        data-team-id="{{ team.id }}"
                        data-position="{{ player.position }}"
                        data-original-team="{{ player.original_team or '' }}"
                        data-points="{{ player.fantasy_points }}"
                        onclick="showPointsModalFromRow(this)">
                        <td>{{ player.name }}</td>
                        <td><span class="original-team-badge">{{ player.original_team or '-' }}</span></td>
                        <td><span class="position-badge {{ player.position | lower }}">{{ player.position }}</span></td>
                        <td class="points-cell">
                            <span class="points-value" id="points-{{ player.id }}">{{ player.fantasy_points }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

{% set has_sold_players = teams | map(attribute='players') | sum(start=[]) | selectattr('status', 'equalto', 'sold') | list | length > 0 %}
{% if not teams or not has_sold_players %}
<div class="no-data-message">
    <p>No players have been sold yet. Complete the auction first to manage fantasy points.</p>
</div>
{% endif %}

<!-- Fantasy Points Modal -->
<div id="fantasyModal" class="modal">
    <div class="modal-content fantasy-modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 id="modalPlayerName">Player Name - Fantasy Points</h3>
        
        <div class="modal-total-points">
            <span>Total Points:</span>
            <span id="modalTotalPoints" class="total-value">0</span>
        </div>
        
        <div id="matchPointsContainer">
            <!-- Match points will be loaded here -->
        </div>
        
        {% if admin_mode %}
        <div class="add-points-section">
            <h4>‚ûï Add Match Points</h4>
            <div class="add-points-form">
                <div class="form-group">
                    <label for="matchNumber">Match #</label>
                    <input type="number" id="matchNumber" min="1" placeholder="Match">
                </div>
                <div class="form-group">
                    <label for="matchPoints">Points</label>
                    <input type="number" id="matchPoints" step="0.5" placeholder="Points">
                </div>
                <button class="btn btn-primary" onclick="addMatchPoints()">Add Points</button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentPlayerId = null;
let currentTeamId = null;
const isAdmin = {{ 'true' if admin_mode else 'false' }};

// Fetch images for award winners
async function fetchAllAwardImages() {
    const selects = ['mvp-select', 'orange-cap-select', 'purple-cap-select'];
    let fetchCount = 0;
    
    for (const selectId of selects) {
        const select = document.getElementById(selectId);
        if (select && select.value) {
            try {
                const response = await fetch(`/api/players/${select.value}/fetch-image`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    fetchCount++;
                }
            } catch (e) {
                console.error('Error fetching image:', e);
            }
        }
    }
    
    if (fetchCount > 0) {
        showNotification(`Fetched ${fetchCount} award winner image(s). Refreshing...`, 'success');
        setTimeout(() => location.reload(), 1500);
    } else {
        showNotification('No images found or no award winners selected', 'info');
    }
}

// Helper to show modal using data attributes (safe for special characters in names)
function showPointsModalFromRow(row) {
    const playerId = parseInt(row.dataset.playerId);
    const playerName = row.dataset.playerName;
    const teamId = parseInt(row.dataset.teamId);
    showPointsModal(playerId, playerName, teamId);
}

// Track sort state for each team
const sortState = {};

function sortTable(teamId, sortBy) {
    const table = document.getElementById(`table-${teamId}`);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Initialize or toggle sort state
    if (!sortState[teamId]) {
        sortState[teamId] = { column: null, ascending: true };
    }
    
    // Toggle direction if same column, otherwise reset to descending for points, ascending for position
    if (sortState[teamId].column === sortBy) {
        sortState[teamId].ascending = !sortState[teamId].ascending;
    } else {
        sortState[teamId].column = sortBy;
        sortState[teamId].ascending = sortBy === 'position'; // ascending for position, descending for points
    }
    
    const ascending = sortState[teamId].ascending;
    
    // Position order for sorting
    const positionOrder = { 'Batter': 1, 'Keeper': 2, 'Allrounder': 3, 'Bowler': 4 };
    
    rows.sort((a, b) => {
        let valA, valB;
        
        if (sortBy === 'position') {
            valA = positionOrder[a.dataset.position] || 99;
            valB = positionOrder[b.dataset.position] || 99;
        } else if (sortBy === 'points') {
            valA = parseFloat(a.dataset.points) || 0;
            valB = parseFloat(b.dataset.points) || 0;
        }
        
        if (ascending) {
            return valA - valB;
        } else {
            return valB - valA;
        }
    });
    
    // Re-append rows in sorted order
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort icons
    updateSortIcons(teamId, sortBy, ascending);
}

function updateSortIcons(teamId, activeColumn, ascending) {
    // Reset all icons for this team
    const positionIcon = document.getElementById(`sort-position-${teamId}`);
    const pointsIcon = document.getElementById(`sort-points-${teamId}`);
    
    if (positionIcon) positionIcon.textContent = '‚áÖ';
    if (pointsIcon) pointsIcon.textContent = '‚áÖ';
    
    // Set active icon
    const activeIcon = document.getElementById(`sort-${activeColumn}-${teamId}`);
    if (activeIcon) {
        activeIcon.textContent = ascending ? '‚Üë' : '‚Üì';
    }
}

async function showPointsModal(playerId, playerName, teamId) {
    currentPlayerId = playerId;
    currentTeamId = teamId;
    
    const modal = document.getElementById('fantasyModal');
    const playerNameEl = document.getElementById('modalPlayerName');
    const containerEl = document.getElementById('matchPointsContainer');
    
    playerNameEl.textContent = playerName + ' - Fantasy Points';
    containerEl.innerHTML = '<p>Loading...</p>';
    modal.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/fantasy/points/${playerId}`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('modalTotalPoints').textContent = data.player.total_points;
            
            if (data.entries.length > 0) {
                let html = `
                    <table class="match-points-table">
                        <thead>
                            <tr>
                                <th>Match #</th>
                                <th>Points</th>
                                ${isAdmin ? '<th>Action</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.entries.forEach(entry => {
                    html += `
                        <tr>
                            <td>Match ${entry.match_number}</td>
                            <td class="points-cell">${entry.points}</td>
                            ${isAdmin ? `<td><button class="btn btn-small btn-danger" onclick="deleteMatchPoints(${entry.id})">üóëÔ∏è</button></td>` : ''}
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                containerEl.innerHTML = html;
            } else {
                containerEl.innerHTML = '<p class="no-matches">No match points recorded yet.</p>';
            }
            
            // Reset add form
            if (isAdmin) {
                const nextMatch = data.entries.length > 0 
                    ? Math.max(...data.entries.map(e => e.match_number)) + 1 
                    : 1;
                document.getElementById('matchNumber').value = nextMatch;
                document.getElementById('matchPoints').value = '';
            }
        } else {
            containerEl.innerHTML = '<p class="error">Error loading points: ' + escapeHtml(data.error) + '</p>';
        }
    } catch (error) {
        containerEl.innerHTML = '<p class="error">Error loading points: ' + escapeHtml(error.message) + '</p>';
    }
}

function closeModal() {
    document.getElementById('fantasyModal').style.display = 'none';
    currentPlayerId = null;
    currentTeamId = null;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('fantasyModal');
    if (event.target === modal) {
        closeModal();
    }
}

async function addMatchPoints() {
    if (!currentPlayerId) return;
    
    const matchNumber = parseInt(document.getElementById('matchNumber').value);
    const points = parseFloat(document.getElementById('matchPoints').value);
    
    if (!matchNumber || matchNumber < 1) {
        alert('Please enter a valid match number');
        return;
    }
    
    if (isNaN(points)) {
        alert('Please enter points value');
        return;
    }
    
    try {
        const response = await fetch('/api/fantasy/points/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                player_id: currentPlayerId,
                match_number: matchNumber,
                points: points
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Refresh the modal
            const playerName = document.getElementById('modalPlayerName').textContent.replace(' - Fantasy Points', '');
            showPointsModal(currentPlayerId, playerName, currentTeamId);
            
            // Update the main table
            document.getElementById(`points-${currentPlayerId}`).textContent = data.total_points;
            updateTeamTotal(currentTeamId);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error adding points: ' + error.message);
    }
}

async function deleteMatchPoints(entryId) {
    if (!confirm('Are you sure you want to delete this match entry?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/fantasy/points/delete/${entryId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Refresh the modal
            const playerName = document.getElementById('modalPlayerName').textContent.replace(' - Fantasy Points', '');
            showPointsModal(currentPlayerId, playerName, currentTeamId);
            
            // Update the main table
            document.getElementById(`points-${currentPlayerId}`).textContent = data.total_points;
            updateTeamTotal(currentTeamId);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting entry: ' + error.message);
    }
}

function updateTeamTotal(teamId) {
    const rows = document.querySelectorAll(`tr[data-team-id="${teamId}"]`);
    let total = 0;
    
    rows.forEach(row => {
        const playerId = row.dataset.playerId;
        const pointsEl = document.getElementById(`points-${playerId}`);
        total += parseFloat(pointsEl.textContent) || 0;
    });
    
    const totalEl = document.getElementById(`team-total-${teamId}`);
    if (totalEl) {
        totalEl.textContent = total.toFixed(1);
    }
}

async function setAward(awardType, playerId) {
    try {
        const response = await fetch('/api/fantasy/award', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ award_type: awardType, player_id: playerId || null })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show brief success feedback
            const select = document.getElementById(`${awardType.replace('_', '-')}-select`);
            select.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                select.style.backgroundColor = '';
            }, 500);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error setting award: ' + error.message);
    }
}

// Filter functionality - dynamically get values from page data
function getUniqueValues(attribute) {
    const values = new Set();
    document.querySelectorAll('.player-row').forEach(row => {
        const val = row.dataset[attribute];
        if (val && val.trim()) values.add(val.trim());
    });
    return Array.from(values).sort();
}

const positions = ['Batter', 'Keeper', 'Allrounder', 'Bowler'];

function updateFilterOptions() {
    const filterType = document.getElementById('filterType').value;
    const filterValueSelect = document.getElementById('filterValue');
    
    if (filterType === 'none') {
        filterValueSelect.style.display = 'none';
        clearFilter();
        return;
    }
    
    filterValueSelect.style.display = 'inline-block';
    filterValueSelect.innerHTML = '<option value="">Select...</option>';
    
    // Get dynamic values from page data
    const options = filterType === 'team' ? getUniqueValues('originalTeam') : positions;
    options.forEach(opt => {
        filterValueSelect.innerHTML += `<option value="${opt}">${opt}</option>`;
    });
}

function applyFilter() {
    const filterType = document.getElementById('filterType').value;
    const filterValue = document.getElementById('filterValue').value;
    
    if (!filterValue) {
        clearFilter();
        return;
    }
    
    const allRows = document.querySelectorAll('.player-row');
    
    allRows.forEach(row => {
        let match = false;
        
        if (filterType === 'team') {
            match = row.dataset.originalTeam === filterValue;
        } else if (filterType === 'position') {
            match = row.dataset.position === filterValue;
        }
        
        row.style.display = match ? '' : 'none';
    });
    
    // Hide team cards with no visible players
    updateTeamCardVisibility();
}

function clearFilter() {
    document.getElementById('filterType').value = 'none';
    document.getElementById('filterValue').value = '';
    document.getElementById('filterValue').style.display = 'none';
    
    const allRows = document.querySelectorAll('.player-row');
    allRows.forEach(row => {
        row.style.display = '';
    });
    
    // Show all team cards
    document.querySelectorAll('.fantasy-card').forEach(card => {
        card.style.display = '';
    });
}

function updateTeamCardVisibility() {
    document.querySelectorAll('.fantasy-card').forEach(card => {
        const visibleRows = card.querySelectorAll('.player-row[style=""], .player-row:not([style])');
        const hiddenRows = card.querySelectorAll('.player-row[style*="display: none"]');
        
        // Check if all rows in this card are hidden
        const allRows = card.querySelectorAll('.player-row');
        const allHidden = Array.from(allRows).every(row => row.style.display === 'none');
        
        card.style.display = allHidden ? 'none' : '';
    });
}

// Sort all tables by position on page load
document.addEventListener('DOMContentLoaded', function() {
    const teamCards = document.querySelectorAll('.fantasy-card[data-team-id]');
    teamCards.forEach(card => {
        const teamId = card.dataset.teamId;
        if (teamId) {
            sortTable(parseInt(teamId), 'points');
        }
    });
});
</script>
{% endblock %}
